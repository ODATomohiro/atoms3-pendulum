<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ATOMS3 ÊåØ„ÇäÂ≠êÂä†ÈÄüÂ∫¶„É¢„Éã„Çø</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top left, #e0f2fe, #eef2ff 40%, #f9fafb 80%);
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.06);
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --ax-color: #f97373;
      --ay-color: #22c55e;
      --az-color: #06b6d4;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px 12px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1000px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      padding: 22px 22px 20px;
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    header.card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    .title-block h1 {
      font-size: 1.35rem;
      letter-spacing: 0.02em;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.12);
    }

    .subtitle {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .chip {
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .chip-dot.ax {
      background: var(--ax-color);
    }
    .chip-dot.ay {
      background: var(--ay-color);
    }
    .chip-dot.az {
      background: var(--az-color);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    button {
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      padding: 7px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.12s ease, border-color 0.12s ease;
      white-space: nowrap;
    }

    button span.icon {
      font-size: 0.9rem;
    }

    #connectBtn {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      padding-inline: 16px;
    }
    #connectBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.4);
      background: #1d4ed8;
    }

    #clearBtn {
      background: #f9fafb;
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
    }
    #clearBtn:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
    }

    #downloadBtn {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    #downloadBtn:hover {
      background: #dcfce7;
      transform: translateY(-1px);
    }

    #status {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 0 3px rgba(248, 171, 96, 0.3);
    }
    .status-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.35);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid rgba(209, 213, 219, 0.8);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-dot.ax {
      background: var(--ax-color);
    }
    .legend-dot.ay {
      background: var(--ay-color);
    }
    .legend-dot.az {
      background: var(--az-color);
    }

    .canvas-shell {
      border-radius: 18px;
      padding: 10px 14px 14px;
      background: radial-gradient(
        circle at top left,
        rgba(37, 99, 235, 0.08),
        transparent 55%
      );
      border: 1px solid rgba(209, 213, 219, 0.8);
      overflow: hidden;
    }

    canvas {
      border-radius: 14px;
      display: block;
      width: 100%;
      max-width: 960px;
      height: 360px;
      background: #ffffff;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .hint-badge {
      padding: 1px 6px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 0.7rem;
      color: #1d4ed8;
    }

    #tableSection {
      margin-top: 16px;
      max-width: 100%;
      display: none;
    }

    #tableHeaderRow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }

    #tableHeaderRow h2 {
      font-size: 0.9rem;
      margin: 0;
    }

    #tableHeaderRow .mini-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    #tableWrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
    }

    #dataTable {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
      min-width: 360px;
    }

    #dataTable thead {
      position: sticky;
      top: 0;
      background: #e5f0ff;
      z-index: 1;
    }

    #dataTable th,
    #dataTable td {
      border-bottom: 1px solid #e5e7eb;
      padding: 4px 8px;
      text-align: right;
      white-space: nowrap;
    }

    #dataTable th {
      font-weight: 600;
      color: #1f2937;
      border-bottom: 1px solid #cbd5f5;
    }

    #dataTable tbody tr:nth-child(even) td {
      background: #f9fafb;
    }

    #dataTable tbody tr:hover td {
      background: #eef2ff;
    }

    .footer {
      margin-top: 8px;
      text-align: center;
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .footer span {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(249, 250, 251, 0.7);
      backdrop-filter: blur(6px);
      display: inline-block;
    }

    /* --- CSV „É¢„Éº„ÉÄ„É´ --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      width: min(640px, 92vw);
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.45);
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.9rem;
    }

    .modal-title {
      font-weight: 600;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .modal-body {
      padding: 10px 14px 14px;
      flex: 1;
      display: flex;
    }

    #csvText {
      width: 100%;
      height: 210px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 10px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      white-space: pre;
    }

    .modal-buttons button {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .btn-primary {
      background: #22c55e;
      color: #ffffff;
      border-color: #16a34a;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-light {
      background: #f3f4f6;
      color: #111827;
      border-color: #e5e7eb;
    }

    .btn-light:hover {
      background: #e5e7eb;
    }

    .btn-outline {
      background: #ffffff;
      color: #6b7280;
      border-color: #d1d5db;
    }

    .btn-outline:hover {
      background: #f9fafb;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px 14px 14px;
        border-radius: 20px;
      }
      header.card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .chip-row {
        justify-content: flex-start;
      }
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      #status {
        margin-left: 0;
      }
      canvas {
        height: 260px;
      }
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .modal-buttons {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="card">
      <header class="card-header">
        <div class="title-block">
          <h1>
            ATOMS3 ÊåØ„ÇäÂ≠êÂä†ÈÄüÂ∫¶„É¢„Éã„Çø
            <span class="badge">Physics Lab ¬∑ Web Serial</span>
          </h1>
          <p class="subtitle">
            ATOMS3 „ÅÆÂä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Åã„Çâ„É™„Ç¢„É´„Çø„Ç§„É†„Åß„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„ÄÅÊ≥¢ÂΩ¢„Å®Ë°®„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ
          </p>
        </div>
        <div class="chip-row">
          <div class="chip">
            <span class="chip-dot ax"></span>
            ax: tangential?
          </div>
          <div class="chip">
            <span class="chip-dot ay"></span>
            ay: radial?
          </div>
          <div class="chip">
            <span class="chip-dot az"></span>
            az: gravity ref.
          </div>
        </div>
      </header>

      <div class="controls-row">
        <button id="connectBtn">
          <span class="icon">üîó</span>
          <span>„Ç∑„É™„Ç¢„É´Êé•Á∂ö</span>
        </button>
        <button id="clearBtn">
          <span class="icon">üßπ</span>
          <span>„Ç∞„É©„Éï„ÉªË°®„ÇØ„É™„Ç¢</span>
        </button>
        <button id="downloadBtn">
          <span class="icon">üíæ</span>
          <span>CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
        </button>
        <div id="status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Êú™Êé•Á∂ö</span>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-dot ax"></span>
          ax (m/s¬≤)
        </div>
        <div class="legend-item">
          <span class="legend-dot ay"></span>
          ay (m/s¬≤)
        </div>
        <div class="legend-item">
          <span class="legend-dot az"></span>
          az (m/s¬≤)
        </div>
      </div>

      <div class="canvas-shell">
        <canvas id="plot"></canvas>
      </div>

      <div class="hint">
        <span class="hint-badge">„Éí„É≥„Éà</span>
        <span>
          Chrome / Edge „Å™„Å© Web Serial ÂØæÂøú„Éñ„É©„Ç¶„Ç∂„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          Arduino ÂÅ¥„ÅÆ„Éú„Éº„É¨„Éº„Éà„ÅØ <strong>115200</strong> „Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </span>
      </div>

      <section id="tableSection">
        <div id="tableHeaderRow">
          <h2>„Éá„Éº„ÇøË°®Ôºà„Ç≥„Éî„ÉºÁî®Ôºâ</h2>
          <div class="mini-hint">
            Ë°®ÂÜÖ„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí <strong>Ctrl+A</strong> ‚Üí <strong>Ctrl+C</strong> „Åß„Ç≥„Éî„Éº„Åó„ÄÅ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÁ≠â„Å´Ë≤º„Çä‰ªò„Åë„Åß„Åç„Åæ„Åô„ÄÇ
          </div>
        </div>
        <div id="tableWrapper">
          <table id="dataTable">
            <thead>
              <tr>
                <th>t_s</th>
                <th>ax_mps2</th>
                <th>ay_mps2</th>
                <th>az_mps2</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <footer class="footer">
      <span>Designed by ODA Tomohiro</span>
    </footer>

    <!-- CSV / TSV „É¢„Éº„ÉÄ„É´ -->
    <div id="csvModal" class="modal-backdrop" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">„Éá„Éº„Çø</div>
          <div class="modal-buttons">
            <button id="copyTsvBtn" class="btn-light">„Ç≥„Éî„ÉºÔºàTSVÔºâ</button>
            <button id="saveCsvBtn" class="btn-primary">CSV‰øùÂ≠ò</button>
            <button id="closeModalBtn" class="btn-outline">Èñâ„Åò„Çã</button>
          </div>
        </div>
        <div class="modal-body">
          <textarea id="csvText" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
  </main>

  <script>
    const connectBtn = document.getElementById("connectBtn");
    const clearBtn = document.getElementById("clearBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const canvas = document.getElementById("plot");
    const ctx = canvas.getContext("2d");

    const tableSection = document.getElementById("tableSection");
    const dataTable = document.getElementById("dataTable");
    const tableBody = dataTable.querySelector("tbody");

    // CSV / TSV „É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
    const csvModal = document.getElementById("csvModal");
    const csvText = document.getElementById("csvText");
    const copyTsvBtn = document.getElementById("copyTsvBtn");
    const saveCsvBtn = document.getElementById("saveCsvBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");

    let lastCsvText = "";
    let lastTsvText = "";

    const maxPoints = 2000;
    let data = [];

    let port = null;
    let reader = null;
    let keepReading = false;
    const textDecoder = new TextDecoder();
    let readBuffer = "";

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      const targetHeightCss = window.innerWidth <= 640 ? 260 : 360;
      canvas.height = targetHeightCss * window.devicePixelRatio;
      draw();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function setStatus(connected) {
      if (connected) {
        statusDot.classList.add("connected");
        statusText.textContent = "Êé•Á∂öÊ∏à„Åø";
        connectBtn.firstElementChild.textContent = "üîå";
        connectBtn.lastElementChild.textContent = "ÂàáÊñ≠";
      } else {
        statusDot.classList.remove("connected");
        statusText.textContent = "Êú™Êé•Á∂ö";
        connectBtn.firstElementChild.textContent = "üîó";
        connectBtn.lastElementChild.textContent = "„Ç∑„É™„Ç¢„É´Êé•Á∂ö";
      }
    }

    connectBtn.addEventListener("click", async () => {
      try {
        if (!("serial" in navigator)) {
          alert(
            "„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ Web Serial API „Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome / Edge „Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          );
          return;
        }

        if (!port) {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });
          setStatus(true);
          keepReading = true;
          startReading();
        } else {
          keepReading = false;
          if (reader) {
            try {
              await reader.cancel();
            } catch (e) {}
            reader = null;
          }
          try {
            await port.close();
          } catch (e) {}
          port = null;
          setStatus(false);
        }
      } catch (err) {
        console.error(err);
        alert("„Ç∑„É™„Ç¢„É´Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + err);
        setStatus(false);
      }
    });

    clearBtn.addEventListener("click", () => {
      data = [];
      draw();
      tableBody.innerHTML = "";
      tableSection.style.display = "none";
    });

    downloadBtn.addEventListener("click", () => {
      if (data.length === 0) {
        alert("‰øùÂ≠ò„ÉªË°®Á§∫„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
        return;
      }
      renderTableFromData();

      let csv = "t_s,ax_mps2,ay_mps2,az_mps2¬•n";
      let tsv = "t_s¬•tax_mps2¬•tay_mps2¬•taz_mps2¬•n";

      for (const p of data) {
        const rowArr = [
          p.t.toFixed(4),
          p.ax.toFixed(4),
          p.ay.toFixed(4),
          p.az.toFixed(4),
        ];
        csv += rowArr.join(",") + "¬•n";
        tsv += rowArr.join("¬•t") + "¬•n";
      }

      lastCsvText = csv;
      lastTsvText = tsv;
      csvText.value = tsv;

      csvModal.style.display = "flex";
    });

    // „Äå„Ç≥„Éî„ÉºÔºàTSVÔºâ„Äç„Éú„Çø„É≥
    copyTsvBtn.addEventListener("click", async () => {
      if (!lastTsvText) return;
      try {
        await navigator.clipboard.writeText(lastTsvText);
        const original = copyTsvBtn.textContent;
        copyTsvBtn.textContent = "„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü";
        setTimeout(() => {
          copyTsvBtn.textContent = original;
        }, 1200);
      } catch (e) {
        alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: " + e);
      }
    });

    // „ÄåCSV‰øùÂ≠ò„Äç„Éú„Çø„É≥
    saveCsvBtn.addEventListener("click", () => {
      if (!lastCsvText) return;

      const blob = new Blob([lastCsvText], { type: "text/csv" });
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      const filename = `atoms3_pendulum_${y}${m}${d}_${hh}${mm}${ss}.csv`;

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // „ÄåÈñâ„Åò„Çã„Äç„Éú„Çø„É≥
    closeModalBtn.addEventListener("click", () => {
      csvModal.style.display = "none";
    });

    function renderTableFromData() {
      tableBody.innerHTML = "";
      let html = "";
      for (const p of data) {
        html +=
          "<tr>" +
          `<td>${p.t.toFixed(4)}</td>` +
          `<td>${p.ax.toFixed(4)}</td>` +
          `<td>${p.ay.toFixed(4)}</td>` +
          `<td>${p.az.toFixed(4)}</td>` +
          "</tr>";
      }
      tableBody.innerHTML = html;
      tableSection.style.display = "block";
    }

    async function startReading() {
      while (port && keepReading) {
        try {
          reader = port.readable.getReader();
          for (;;) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              const chunk = textDecoder.decode(value, { stream: true });
              console.log("chunk:", chunk);
              handleSerialChunk(chunk);
            }
          }
        } catch (err) {
          console.error("read error:", err);
          break;
        } finally {
          if (reader) {
            reader.releaseLock();
            reader = null;
          }
        }
      }
    }

    function handleSerialChunk(chunk) {
      readBuffer += chunk;
      const lines = readBuffer.split("¬•n");
      readBuffer = lines.pop();

      for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        console.log("line:", line);
        if (line.startsWith("t_s")) continue;
        const parts = line.split(",");
        if (parts.length < 4) continue;

        const t = parseFloat(parts[0]);
        const ax = parseFloat(parts[1]);
        const ay = parseFloat(parts[2]);
        const az = parseFloat(parts[3]);
        if (isNaN(t) || isNaN(ax) || isNaN(ay) || isNaN(az)) continue;

        data.push({ t, ax, ay, az });
        if (data.length > maxPoints) {
          data.shift();
        }
      }

      draw();
    }

    function draw() {
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      if (data.length < 2) {
        drawAxes();
        return;
      }

      const tMin = data[0].t;
      const tMax = data[data.length - 1].t;
      const tRange = tMax - tMin || 1.0;

      let aMin = Infinity;
      let aMax = -Infinity;
      for (const p of data) {
        aMin = Math.min(aMin, p.ax, p.ay, p.az);
        aMax = Math.max(aMax, p.ax, p.ay, p.az);
      }
      if (!isFinite(aMin) || !isFinite(aMax)) {
        aMin = -10;
        aMax = 10;
      }
      if (aMax === aMin) {
        aMax += 1;
        aMin -= 1;
      }
      const aRange = aMax - aMin;

      drawAxes(aMin, aMax);

      const styles = getComputedStyle(document.documentElement);
      drawLine(
        (p) => p.ax,
        tMin,
        tRange,
        aMin,
        aRange,
        styles.getPropertyValue("--ax-color") || "#f97373"
      );
      drawLine(
        (p) => p.ay,
        tMin,
        tRange,
        aMin,
        aRange,
        styles.getPropertyValue("--ay-color") || "#22c55e"
      );
      drawLine(
        (p) => p.az,
        tMin,
        tRange,
        aMin,
        aRange,
        styles.getPropertyValue("--az-color") || "#06b6d4"
      );
    }

    function drawAxes(aMin = -10, aMax = 10) {
      const w = canvas.width;
      const h = canvas.height;
      const paddingLeft = 60 * window.devicePixelRatio;
      const paddingRight = 20 * window.devicePixelRatio;
      const paddingTop = 24 * window.devicePixelRatio;
      const paddingBottom = 40 * window.devicePixelRatio;

      ctx.save();
      ctx.strokeStyle = "#9ca3af";
      ctx.lineWidth = 1 * window.devicePixelRatio;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, h - paddingBottom);
      ctx.lineTo(w - paddingRight, h - paddingBottom);
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, h - paddingBottom);
      ctx.stroke();

      ctx.fillStyle = "#6b7280";
      ctx.font = 10 * window.devicePixelRatio + "px system-ui";
      const steps = 5;
      for (let i = 0; i <= steps; i++) {
        const yVal = aMin + ((aMax - aMin) * i) / steps;
        const y =
          paddingTop +
          ((h - paddingTop - paddingBottom) * (steps - i)) / steps;
        ctx.beginPath();
        ctx.moveTo(paddingLeft - 5 * window.devicePixelRatio, y);
        ctx.lineTo(paddingLeft, y);
        ctx.stroke();
        ctx.fillText(
          yVal.toFixed(1),
          8 * window.devicePixelRatio,
          y + 3 * window.devicePixelRatio
        );
      }

      ctx.restore();
    }

    function drawLine(selector, tMin, tRange, aMin, aRange, color) {
      const w = canvas.width;
      const h = canvas.height;
      const paddingLeft = 60 * window.devicePixelRatio;
      const paddingRight = 20 * window.devicePixelRatio;
      const paddingTop = 24 * window.devicePixelRatio;
      const paddingBottom = 40 * window.devicePixelRatio;

      const x0 = paddingLeft;
      const x1 = w - paddingRight;
      const y0 = paddingTop;
      const y1 = h - paddingBottom;

      ctx.save();
      ctx.lineWidth = 1.4 * window.devicePixelRatio;
      ctx.strokeStyle = color || "#2563eb";
      ctx.beginPath();

      let first = true;
      for (const p of data) {
        const tNorm = (p.t - tMin) / tRange;
        const aVal = selector(p);
        const aNorm = (aVal - aMin) / aRange;

        const x = x0 + (x1 - x0) * tNorm;
        const y = y1 - (y1 - y0) * aNorm;

        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
      ctx.restore();
    }
  </script>
</body>
</html>
